<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charet="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC è§†é¢‘é€šè¯å·¥å…· - PeerJSç‰ˆæœ¬</title>
    <tyle>
        * {
            margin: 0;
            padding: 0;
            box-izing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
            diplay: flex;
            flex-direction: column;
            align-item: center;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radiu: 20px;
            padding: 30px;
            box-hadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-ize: 2.5rem;
            margin-bottom: 10px;
            text-hadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .ubtitle {
            font-ize: 1.2rem;
            opacity: 0.9;
        }
        
        .connection-panel {
            diplay: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            background: rgba(30, 30, 50, 0.8);
            border-radius: 15px;
            padding: 20px;
        }
        
        .connection-box {
            flex: 1;
            min-width: 250px;
        }
        
        .connection-box h3 {
            margin-bottom: 15px;
            color: #21CBF3;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .video-box {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 30, 50, 0.8);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .video-title {
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            text-align: center;
            font-weight: bold;
        }
        
        video {
            width: 100%;
            height: 300px;
            background: #000;
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button.primary {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }
        
        button.danger {
            background: linear-gradient(45deg, #f44336, #e91e63);
        }
        
        button.secondary {
            background: linear-gradient(45deg, #FF9800, #FF5722);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .call-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .call-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            width: 150px;
        }
        
        .call-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .call-option.active {
            background: rgba(33, 150, 243, 0.3);
            border: 2px solid #2196F3;
        }
        
        .icon {
            font-size: 2rem;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .video-container {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
            
            .connection-panel {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>WebRTC è§†é¢‘é€šè¯å·¥å…·</h1>
        <p class="subtitle">åŸºäºPeerJSçš„å®æ—¶éŸ³è§†é¢‘é€šä¿¡ - æ— éœ€åç«¯éƒ¨ç½²</p>
    </header>
    
    <div class="container">
        <div class="status" id="status">
            å‡†å¤‡è¿æ¥ï¼Œè¯·é€‰æ‹©é€šè¯ç±»å‹å¹¶åˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´
        </div>
        
        <div class="call-options">
            <div class="call-option active" id="videoOption">
                <div class="icon">ğŸ“¹</div>
                <div>è§†é¢‘é€šè¯</div>
            </div>
            <div class="call-option" id="audioOption">
                <div class="icon">ğŸ™ï¸</div>
                <div>è¯­éŸ³é€šè¯</div>
            </div>
        </div>
        
        <div class="connection-panel">
            <div class="connection-box">
                <h3>åˆ›å»ºæˆ¿é—´</h3>
                <input type="text" id="createRoomInput" placeholder="è¾“å…¥æˆ¿é—´åç§°">
                <button id="createRoomBtn" class="primary">åˆ›å»ºæˆ¿é—´</button>
            </div>
            
            <div class="connection-box">
                <h3>åŠ å…¥æˆ¿é—´</h3>
                <input type="text" id="joinRoomInput" placeholder="è¾“å…¥æˆ¿é—´ID">
                <button id="joinRoomBtn" class="primary">åŠ å…¥æˆ¿é—´</button>
            </div>
        </div>
        
        <div class="video-container">
            <div class="video-box">
                <div class="video-title">æœ¬åœ°è§†é¢‘</div>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div class="video-box">
                <div class="video-title">è¿œç¨‹è§†é¢‘</div>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn" class="primary">
                <span>â–¶ï¸</span> å¼€å§‹é€šè¯
            </button>
            <button id="hangupBtn" class="danger" disabled>
                <span>ğŸ“µ</span> æŒ‚æ–­é€šè¯
            </button>
            <button id="muteBtn" class="secondary">
                <span>ğŸ”‡</span> é™éŸ³
            </button>
            <button id="videoBtn" class="secondary">
                <span>ğŸ“¹</span> å…³é—­è§†é¢‘
            </button>
        </div>
        
        <div class="connection-info">
            <div class="info-box">
                <h3>è¿æ¥ä¿¡æ¯</h3>
                <p>æˆ¿é—´ID: <span id="roomId">æœªåŠ å…¥æˆ¿é—´</span></p>
                <p>è¿æ¥çŠ¶æ€: <span id="connectionStatus">æœªè¿æ¥</span></p>
                <p>æˆ‘çš„ID: <span id="myId">æœªè¿æ¥</span></p>
            </div>
            <div class="info-box">
                <h3>ä½¿ç”¨è¯´æ˜</h3>
                <p>1. é€‰æ‹©é€šè¯ç±»å‹ï¼ˆè§†é¢‘/è¯­éŸ³ï¼‰</p>
                <p>2. åˆ›å»ºæˆ¿é—´æˆ–åŠ å…¥å·²æœ‰æˆ¿é—´</p>
                <p>3. ç‚¹å‡»"å¼€å§‹é€šè¯"è·å–æœ¬åœ°åª’ä½“</p>
                <p>4. ç­‰å¾…å¯¹æ–¹åŠ å…¥æˆ¿é—´</p>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥PeerJSåº“ -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // è·å–DOMå…ƒç´ 
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startBtn = document.getElementById('startBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const muteBtn = document.getElementById('muteBtn');
        const videoBtn = document.getElementById('videoBtn');
        const statusDiv = document.getElementById('status');
        const roomIdSpan = document.getElementById('roomId');
        const connectionStatusSpan = document.getElementById('connectionStatus');
        const myIdSpan = document.getElementById('myId');
        const videoOption = document.getElementById('videoOption');
        const audioOption = document.getElementById('audioOption');
        const createRoomInput = document.getElementById('createRoomInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomInput = document.getElementById('joinRoomInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        
        // çŠ¶æ€å˜é‡
        let localStream = null;
        let remoteStream = null;
        let isMuted = false;
        let isVideoOff = false;
        let isVideoCall = true;
        let currentRoomId = null;
        let peer = null;
        let currentCall = null;
        
        // é€‰æ‹©é€šè¯ç±»å‹
        videoOption.addEventListener('click', () => {
            videoOption.classList.add('active');
            audioOption.classList.remove('active');
            isVideoCall = true;
            updateStatus("å·²é€‰æ‹©è§†é¢‘é€šè¯");
        });
        
        audioOption.addEventListener('click', () => {
            audioOption.classList.add('active');
            videoOption.classList.remove('active');
            isVideoCall = false;
            updateStatus("å·²é€‰æ‹©è¯­éŸ³é€šè¯");
        });
        
        // åˆ›å»ºæˆ¿é—´
        createRoomBtn.addEventListener('click', () => {
            const roomId = createRoomInput.value.trim();
            if (!roomId) {
                alert("è¯·è¾“å…¥æˆ¿é—´åç§°");
                return;
            }
            
            joinRoom(roomId);
        });
        
        // åŠ å…¥æˆ¿é—´
        joinRoomBtn.addEventListener('click', () => {
            const roomId = joinRoomInput.value.trim();
            if (!roomId) {
                alert("è¯·è¾“å…¥æˆ¿é—´ID");
                return;
            }
            
            joinRoom(roomId);
        });
        
        // åŠ å…¥æˆ¿é—´å‡½æ•°
        function joinRoom(roomId) {
            // å¦‚æœå·²ç»è¿æ¥ï¼Œå…ˆæ–­å¼€
            if (peer) {
                peer.destroy();
            }
            
            // åˆ›å»ºPeerå®ä¾‹
            // ä½¿ç”¨PeerJSçš„å…¬å…±æœåŠ¡å™¨
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                debug: 3
            });
            
            peer.on('open', (id) => {
                updateStatus("å·²è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨");
                myIdSpan.textContent = id;
                currentRoomId = roomId;
                roomIdSpan.textContent = roomId;
                
                updateStatus(`å·²åŠ å…¥æˆ¿é—´: ${roomId}ï¼Œæˆ‘çš„ID: ${id}`);
                
                // å¯ç”¨å¼€å§‹é€šè¯æŒ‰é’®
                startBtn.disabled = false;
            });
            
            // ç›‘å¬æ¥ç”µ
            peer.on('call', (call) => {
                updateStatus(`æ”¶åˆ°æ¥è‡ª ${call.peer} çš„é€šè¯è¯·æ±‚`);
                
                // å¦‚æœæœ‰æœ¬åœ°æµï¼Œç›´æ¥åº”ç­”
                if (localStream) {
                    answerCall(call);
                } else {
                    // å¦åˆ™å…ˆè·å–åª’ä½“è®¾å¤‡ï¼Œç„¶ååº”ç­”
                    getMediaStream().then(() => {
                        answerCall(call);
                    });
                }
            });
            
            // ç›‘å¬è¿æ¥æ–­å¼€
            peer.on('disconnected', () => {
                updateStatus("ä¸ä¿¡ä»¤æœåŠ¡å™¨æ–­å¼€è¿æ¥");
                connectionStatusSpan.textContent = "æ–­å¼€è¿æ¥";
            });
            
            // ç›‘å¬é”™è¯¯
            peer.on('error', (err) => {
                console.error("PeerJSé”™è¯¯:", err);
                updateStatus("è¿æ¥é”™è¯¯: " + err.type);
            });
            
            // ç›‘å¬è¿æ¥å…³é—­
            peer.on('close', () => {
                updateStatus("è¿æ¥å·²å…³é—­");
                connectionStatusSpan.textContent = "å·²å…³é—­";
            });
        }
        
        // å¼€å§‹é€šè¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        startBtn.addEventListener('click', startCall);
        
        // æŒ‚æ–­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        hangupBtn.addEventListener('click', hangUp);
        
        // é™éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        muteBtn.addEventListener('click', toggleMute);
        
        // è§†é¢‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        videoBtn.addEventListener('click', toggleVideo);
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message) {
            statusDiv.textContent = message;
            console.log(message);
        }
        
        // è·å–åª’ä½“æµ
        async function getMediaStream() {
            try {
                // æ ¹æ®é€‰æ‹©çš„é€šè¯ç±»å‹è¯·æ±‚åª’ä½“æµ
                const constraints = {
                    audio: true,
                    video: isVideoCall
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                localVideo.srcObject = localStream;
                
                updateStatus("åª’ä½“è®¾å¤‡å·²å°±ç»ª");
                return localStream;
            } catch (error) {
                console.error("è·å–åª’ä½“è®¾å¤‡å¤±è´¥:", error);
                updateStatus("è·å–åª’ä½“è®¾å¤‡å¤±è´¥: " + error.message);
                throw error;
            }
        }
        
        // å¼€å§‹é€šè¯
        async function startCall() {
            updateStatus("æ­£åœ¨è·å–åª’ä½“è®¾å¤‡æƒé™...");
            
            try {
                await getMediaStream();
                
                updateStatus("æ­£åœ¨å‘¼å«å¯¹æ–¹...");
                startBtn.disabled = true;
                hangupBtn.disabled = false;
                
                // å‘¼å«æˆ¿é—´å†…çš„å…¶ä»–ç”¨æˆ·
                // æ³¨æ„ï¼šPeerJSæ²¡æœ‰å†…ç½®çš„æˆ¿é—´æ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‡è®¾å¯¹æ–¹çŸ¥é“æˆ‘ä»¬çš„ID
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨éœ€è¦å®ç°è‡ªå·±çš„æˆ¿é—´ç®¡ç†é€»è¾‘
                // è¿™é‡Œæˆ‘ä»¬å‡è®¾å¯¹æ–¹IDä¸æˆ¿é—´IDç›¸åŒï¼ˆç®€åŒ–å®ç°ï¼‰
                currentCall = peer.call(currentRoomId, localStream);
                
                currentCall.on('stream', (remoteStream) => {
                    remoteVideo.srcObject = remoteStream;
                    updateStatus("é€šè¯å·²è¿æ¥");
                    connectionStatusSpan.textContent = "å·²è¿æ¥";
                });
                
                currentCall.on('close', () => {
                    updateStatus("é€šè¯å·²ç»“æŸ");
                    hangUp();
                });
                
                currentCall.on('error', (err) => {
                    console.error("é€šè¯é”™è¯¯:", err);
                    updateStatus("é€šè¯é”™è¯¯: " + err.message);
                    hangUp();
                });
                
            } catch (error) {
                console.error("å¼€å§‹é€šè¯å¤±è´¥:", error);
                updateStatus("å¼€å§‹é€šè¯å¤±è´¥: " + error.message);
            }
        }
        
        // åº”ç­”æ¥ç”µ
        function answerCall(call) {
            updateStatus("æ­£åœ¨åº”ç­”é€šè¯...");
            currentCall = call;
            
            call.answer(localStream);
            
            call.on('stream', (remoteStream) => {
                remoteVideo.srcObject = remoteStream;
                updateStatus("é€šè¯å·²è¿æ¥");
                connectionStatusSpan.textContent = "å·²è¿æ¥";
                hangupBtn.disabled = false;
            });
            
            call.on('close', () => {
                updateStatus("é€šè¯å·²ç»“æŸ");
                hangUp();
            });
            
            call.on('error', (err) => {
                console.error("é€šè¯é”™è¯¯:", err);
                updateStatus("é€šè¯é”™è¯¯: " + err.message);
                hangUp();
            });
        }
        
        // æŒ‚æ–­é€šè¯
        function hangUp() {
            updateStatus("é€šè¯ç»“æŸ");
            
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            
            if (localStream) {
                localStream.getTrack().forEach(track => track.stop());
                localStream = null;
            }
            
            localVideo.rcObject = null;
            remoteVideo.rcObject = null;
            
tartBtn.diabled = true;
            hangupBtn.diabled = true;
            
            roomIdSpan.textContent = "æœªåŠ å…¥æˆ¿é—´";
            connectionStatuSpan.textContent = "æœªè¿æ¥";
            
            // é‡ç½®çŠ¶æ€
            currentRoomId = null;
        }
        
        // åˆ‡æ¢é™éŸ³
        function toggleMute() {
            if (!localStream) return;
            
            cont audioTrack = localStream.getAudioTracks();
            if (audioTrack.length === 0) return;
            
            iMuted = !isMuted;
            audioTrack[0].enabled = !isMuted;
            
            muteBtn.innerHTML = isMuted ? '<span>ğŸ”Š</span> å–æ¶ˆé™éŸ³' : '<span>ğŸ”‡</span> é™éŸ³';
            updateStatu(iMuted ? "å·²é™éŸ³" : "å·²å–æ¶ˆé™éŸ³");
        }
        
        // åˆ‡æ¢è§†é¢‘
        function toggleVideo() {
            if (!localStream || !iVideoCall) return;
            
            cont videoTrack = localStream.getVideoTracks();
            if (videoTrack.length === 0) return;
            
            iVideoOff = !isVideoOff;
            videoTrack[0].enabled = !isVideoOff;
            
            videoBtn.innerHTML = isVideoOff ? '<span>ğŸ“¹</span> å¼€å¯è§†é¢‘' : '<span>ğŸš«</span> å…³é—­è§†é¢‘';
            updateStatu(iVideoOff ? "è§†é¢‘å·²å…³é—­" : "è§†é¢‘å·²å¼€å¯");
        }
    </cript>
</body>
</html>
